---
- hosts: all
  vars: 
    haproxy_group: haproxy
    haproxy_user: haproxy
    haproxy_version: 1.7
    haproxy_port: 80
    haproxy_global:
      - "daemon"
      - "maxconn 256"
        
    haproxy_frontend_port: 80
    haproxy_servers_balance: roundrobin
    haproxy_servers: 
      - "web1 192.168.2.133:80"
      - "web2 192.168.2.135:80"
    
  tasks:
    - name: install haproxy
      yum: 
        name: haproxy
        state: latest

    - name: Template out haproxy cfg
      template:
        src: templates/haproxy.j2
        dest: /etc/haproxy/haproxy.cfg
        owner: haproxy
        group: haproxy
        mode: 0644
    - name: Add lines for each server
      lineinfile:
        path: /etc/haproxy/haproxy.cfg
        line: '    server {{ item }} check'
        insertafter: EOF
      with_items: "{{ haproxy_servers }}"
    - name: start haproxy
      service:
        name: haproxy
        state: restarted
